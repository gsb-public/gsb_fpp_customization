<?php

/**
 * This function will add a select dropdown with the workbench sections as option
 * choices for the user.
 */
function gsb_fpp_customization_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'fieldable_panels_panes_fieldable_panels_pane_content_type_edit_form') {

    global $user;
    
    workbench_access_user_load_data($user);
    $active = workbench_access_get_active_tree();
    $account_access = array_keys($user->workbench_access);

    $category = array();

    foreach ($account_access as $key => $value) {
      if (isset($active['tree'][$value])) {
        $category = $active['tree'][$value]['name'];
        $categories[$category] = $category;
      }
    }

    if (isset($form_state['process_input']) && $form_state['process_input'] == TRUE) {
      $form['reusable']['category']['#value'] = $form_state['input']['category'];
    } else {
      $form['reusable']['category']['#value'] = '';
    }
    
    $form['reusable']['category']['#type'] = 'select';
    $form['reusable']['category']['#options'] = $categories;

  }

}

/**
 * Preprocess the panels_add_content_modal() function to remove any
 * categories (workbench sections) that the user doesn't have access to.
 */
function gsb_fpp_customization_preprocess_panels_add_content_modal(&$vars) {

    global $user;

    workbench_access_user_load_data($user);
  
    $active = workbench_access_get_active_tree();
    $active_category_ids = array_keys($active['tree']);
    
    $workbench_access = $user->workbench_access;
  
    // find the categories that are not accessable to the user ...
  
    $remove_items = array();

    foreach ($active_category_ids as $key => $value) {
      if (!isset($workbench_access[$value])) {
        $remove_items[] = $active['tree'][$value]['name'];
      }
    }
    
    // ... and remove them from the list that is displayed

    $index = 0;
    foreach($vars['categories'] as $key => $value) {
      if ($key == 'root') {
        continue;
      }
      if (in_array($key, $remove_items)) {
        unset($vars['categories_array'][$index]);
        unset($vars['categories'][$key]);
      }
      $index++;
    }

}

function gsb_fpp_customization_page_alter(&$page) {

  global $user;

  if (arg(0) == 'node') {
    $nid = arg(1);
  } else {
    return;
  }

  if (isset($page['page_bottom']['panels_ipe'])) {

    $active = workbench_access_get_active_tree();

    $result = db_select('workbench_access_node', 'wan')
      ->fields('wan', array('nid', 'access_id', 'access_scheme'))
      ->condition('nid', $nid)
      ->execute()
      ->fetchAssoc();

    workbench_access_user_load_data($user);
    $workbench_access = $user->workbench_access;

    $access_id = "";

    if (isset($result['access_id'])) {
      $access_id = $result['access_id'];
    }

    if (!isset($workbench_access[$access_id])) {
      unset($page['page_bottom']['panels_ipe']);
    }

  }
}



